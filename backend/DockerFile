FROM debian:12-slim

# 1. Installation des dépendances système
RUN apt-get update && apt-get install -y \
    python3 \
    python3-pip \
    && rm -rf /var/lib/apt/lists/*

# 2. Structure de dossiers professionnelle
WORKDIR /opt/cloud-api
RUN mkdir app data scripts

# 3. Installation des dépendances Python
RUN pip3 install --no-cache-dir flask gunicorn --break-system-packages

# 4. Copie des fichiers
COPY ./scripts/start.sh ./scripts/start.sh
COPY ./app.py ./app/app.py
RUN chmod +x ./scripts/start.sh

# 5. Sécurité : Utilisateur non-privilégié
RUN useradd -m apiuser && chown -R apiuser:apiuser /opt/cloud-api
USER apiuser

# 6. Lancement via le script pour gestion propre du SIGTERM
ENTRYPOINT ["/opt/cloud-api/scripts/start.sh"]